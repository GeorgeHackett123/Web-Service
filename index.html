<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Web-Service 3D Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #container { display: flex; height: 100vh; }
        #cesiumContainer { flex: 2; min-width: 0; }
        #marzipanoModal {
            display: none; position: fixed; z-index: 999;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            align-items: center; justify-content: center;
        }
        #marzipanoBox {
            width: 75vw; height: 75vh; background: #222;
            position: relative; margin: auto;
            border-radius: 8px; overflow: hidden;
        }
        #marzipanoPano { width: 100%; height: 100%; }
        #marzipanoClose {
            position: absolute; top: 10px; right: 18px;
            color: #fff; background: #333; border: none; font-size: 2em;
            z-index: 1000; cursor: pointer; border-radius: 0.3em;
        }
        #marzipanoTitle {
            position: absolute; left: 1em; top: 0.6em; z-index: 2;
            color: #fff; background: rgba(40,40,40,0.6);
            padding: 0.3em 1em; border-radius: 0.4em; font-size: 1.2em;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="cesiumContainer"></div>
</div>
<!-- Marzipano Popup Modal -->
<div id="marzipanoModal">
    <div id="marzipanoBox">
        <span id="marzipanoTitle"></span>
        <button id="marzipanoClose">&times;</button>
        <div id="marzipanoPano"></div>
    </div>
</div>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
<script src="https://www.marzipano.net/demos/vendor/marzipano.js"></script>
<script>
// ---------- (Assume loading of geojson and camera points already done above this point) ----------

// Example for adding a viewcone, update this block wherever you generate the cones:
function addCameraCone(feature) {
    // Compute the heading (yaw) - flip 180°:
    const heading = Cesium.Math.toRadians(feature.properties.Yaw_est + 180);
    const pitch = Cesium.Math.toRadians(feature.properties.Pitch_est || 0);
    const roll = Cesium.Math.toRadians(feature.properties.Roll_est || 0);

    // Your position logic (replace with your real code):
    const position = Cesium.Cartesian3.fromDegrees(
        feature.geometry.coordinates[0],
        feature.geometry.coordinates[1],
        feature.geometry.coordinates[2]
    );

    // Example orientation
    const orientation = Cesium.Transforms.headingPitchRollQuaternion(
        position,
        new Cesium.HeadingPitchRoll(heading, pitch, roll)
    );

    // Add the cone (replace with your real logic):
    viewer.entities.add({
        name: "View Cone",
        position: position,
        orientation: orientation,
        cylinder: {
            length: 20.0,
            topRadius: 0.1,
            bottomRadius: 3.0,
            material: Cesium.Color.YELLOW.withAlpha(0.2),
            outline: true,
            outlineColor: Cesium.Color.YELLOW
        }
    });
}

// ---------- The rest of your Cesium and Marzipano code remains unchanged ----------

/* Marzipano popup with 180° flip (yaw: Math.PI) */
function showMarzipanoPopup(imageUrl, title) {
    document.getElementById('marzipanoModal').style.display = 'flex';
    // Destroy previous viewer
    if (window.panoViewer) {
        window.panoViewer.destroy();
    }
    // Create Marzipano viewer
    window.panoViewer = new Marzipano.Viewer(document.getElementById('marzipanoPano'), { stageType: 'webgl' });

    const source = Marzipano.ImageUrlSource.fromString(imageUrl);
    const geometry = new Marzipano.EquirectGeometry([{ width: 1536 }]);
    const limiter = Marzipano.RectilinearView.limit.traditional(1024, 100 * Math.PI / 180);

    // Flip 360 image by 180°
    const view = new Marzipano.RectilinearView({ yaw: Math.PI }, limiter);

    const scene = window.panoViewer.createScene({ source, geometry, view });
    scene.switchTo();
    document.getElementById('marzipanoTitle').innerText = title || '';
}

document.getElementById('marzipanoClose').onclick = function () {
    document.getElementById('marzipanoModal').style.display = 'none';
    if (window.panoViewer) {
        window.panoViewer.destroy();
        window.panoViewer = null;
    }
};

// (rest of your script unchanged)
</script>
</body>
</html>
