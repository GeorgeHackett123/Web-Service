<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Web-Service 3D Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #container { display: flex; height: 100vh; }
        #cesiumContainer { flex: 2; min-width: 0; }
        #marzipanoModal {
            display: none; position: fixed; z-index: 999;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            align-items: center; justify-content: center;
        }
        #marzipanoBox {
            width: 75vw; height: 75vh; background: #222;
            position: relative; margin: auto;
            border-radius: 8px; overflow: hidden;
        }
        #marzipanoPano { width: 100%; height: 100%; }
        #marzipanoClose {
            position: absolute; top: 10px; right: 18px;
            color: #fff; background: #333; border: none; font-size: 2em;
            z-index: 1000; cursor: pointer; border-radius: 0.3em;
        }
        #marzipanoTitle {
            position: absolute; left: 1em; top: 0.6em; z-index: 2;
            color: #fff; background: rgba(40,40,40,0.6);
            padding: 0.3em 1em; border-radius: 0.4em; font-size: 1.2em;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="cesiumContainer"></div>
</div>
<!-- Marzipano Popup Modal -->
<div id="marzipanoModal">
    <div id="marzipanoBox">
        <span id="marzipanoTitle"></span>
        <button id="marzipanoClose">&times;</button>
        <div id="marzipanoPano"></div>
    </div>
</div>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
<script src="https://www.marzipano.net/demos/vendor/marzipano.js"></script>
<script>
/* -------------- Your Cesium + Overlay/Camera logic here -------------- */
/* ... your previous code to load Cesium viewer, overlays, popups ...    */
/* (Not shown here, to keep focus on Marzipano logic as per your request)*/
/* --------------------------------------------------------------------- */

/* Marzipano popup with 180° flip (yaw: Math.PI) */
function showMarzipanoPopup(imageUrl, title) {
    document.getElementById('marzipanoModal').style.display = 'flex';
    // Destroy previous viewer
    if (window.panoViewer) {
        window.panoViewer.destroy();
    }
    // Create Marzipano viewer
    window.panoViewer = new Marzipano.Viewer(document.getElementById('marzipanoPano'), { stageType: 'webgl' });

    const source = Marzipano.ImageUrlSource.fromString(imageUrl);
    const geometry = new Marzipano.EquirectGeometry([{ width: 1536 }]);
    const limiter = Marzipano.RectilinearView.limit.traditional(1024, 100 * Math.PI / 180);

    // Flip 360 image by 180°
    const view = new Marzipano.RectilinearView({ yaw: Math.PI }, limiter);

    const scene = window.panoViewer.createScene({ source, geometry, view });
    scene.switchTo();
    document.getElementById('marzipanoTitle').innerText = title || '';
}

document.getElementById('marzipanoClose').onclick = function () {
    document.getElementById('marzipanoModal').style.display = 'none';
    if (window.panoViewer) {
        window.panoViewer.destroy();
        window.panoViewer = null;
    }
};

// Example: To trigger the popup with a given image and title, call:
// showMarzipanoPopup('images/your_image.jpg', 'Sample Title');
</script>
</body>
</html>
