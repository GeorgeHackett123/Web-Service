<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Cesium 360 + View Cone Working Example</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marzipano@0.10.1/dist/marzipano.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet"/>
<style>
html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; }
#imagePopup {
  position: fixed; bottom: 20px; right: 20px; width: 45vw; height: 45vh;
  display: none; flex-direction: column; background: white; border: 2px solid #888;
  border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 999; padding:0; margin:0; overflow: hidden;
}
#pano { flex: 1 1 0; width:100%; height:100%; }
.close-btn { position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold; font-size: 18px; color: #888; }
#popupLabel { font-size: 14px; padding: 5px 0 0 8px; }
</style>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="imagePopup">
  <span class="close-btn" onclick="closeImagePopup()">âœ–</span>
  <div id="pano"></div>
  <div id="popupLabel"></div>
</div>
<script type="module">
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxOTFmZDVlMi03YjgxLTQ1YWUtOWQwZS0xZjljNDM0NjA4YjkiLCJpZCI6MzA0NTQyLCJpYXQiOjE3NDkxMjg1MTN9.Dwyd_sG1jlBEjibzMEzejMEBzkO9M7W43h-ivarmdK8';

// Layer list (adjust filenames as needed)
const overlays = [
  "almar_layer_LineStringZ.geojson",
  "almar_layer_PointZ.geojson",
  "almar_layer_PolygonZ.geojson"
];
let coneEntities = [];
function clearCones(viewer) { for(const e of coneEntities) viewer.entities.remove(e); coneEntities = []; }

function getOverlayStyle(name) {
  if (name.includes("LineStringZ")) return {stroke: Cesium.Color.BROWN, fill: Cesium.Color.BROWN.withAlpha(0.1), strokeWidth:2};
  if (name.includes("PolygonZ")) return {stroke: Cesium.Color.LIME, fill: Cesium.Color.LIME.withAlpha(0.25), strokeWidth:2};
  if (name.includes("PointZ"))   return {stroke: Cesium.Color.WHITE, fill: Cesium.Color.WHITE, strokeWidth:2, pointSize:12};
  return {stroke: Cesium.Color.WHITE, fill: Cesium.Color.WHITE, strokeWidth:2};
}

async function loadOverlays(viewer) {
  for (const file of overlays) {
    const resp = await fetch(file);
    if (!resp.ok) continue;
    const data = await resp.json();
    const style = getOverlayStyle(file);
    const ds = await Cesium.GeoJsonDataSource.load(data, {
      clampToGround:false,
      stroke:style.stroke,
      fill:style.fill,
      strokeWidth:style.strokeWidth,
      markerSize:style.pointSize||0,
      markerSymbol:'',
      markerColor:style.fill
    });
    // Remove billboard icons
    for(const ent of ds.entities.values) if(ent.billboard) delete ent.billboard;
    if(file.includes('PointZ')) {
      for(const ent of ds.entities.values) {
        ent.point = new Cesium.PointGraphics({
          pixelSize: style.pointSize||10,
          color: Cesium.Color.WHITE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 1
        });
      }
    }
    viewer.dataSources.add(ds);
  }
}

async function loadCameraPoints(viewer) {
  const ds = await Cesium.GeoJsonDataSource.load('camera_points_final.geojson', {
    clampToGround:false,
    markerSize:0, markerSymbol:'', markerColor:Cesium.Color.TRANSPARENT
  });
  viewer.dataSources.add(ds);
  viewer.flyTo(ds);
  for(const ent of ds.entities.values) {
    const label = ent.properties?.['#Label'];
    ent.point = new Cesium.PointGraphics({
      pixelSize: 10, color: Cesium.Color.RED,
      outlineColor: Cesium.Color.BLACK, outlineWidth: 2
    });
    ent.popupImageURL = label ? `images/${label}` : null;
    ent.popupLabel = label;
  }
}

function closeImagePopup() {
  document.getElementById('imagePopup').style.display = 'none';
  if(window.panoViewer) { window.panoViewer.destroy(); window.panoViewer = null; }
  if(window.cesiumViewer) clearCones(window.cesiumViewer);
}

// View cone for 360
function drawViewCone(viewer, picked, marzipanoView) {
  clearCones(viewer);
  const pos = picked.id.position.getValue(Cesium.JulianDate.now());
  if(!pos) return;
  const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(pos);
  const lon = Cesium.Math.toDegrees(carto.longitude);
  const lat = Cesium.Math.toDegrees(carto.latitude);
  const height = carto.height + 2.0;
  const rawYaw = parseFloat(picked.id.properties['Yaw_est'].getValue());
  const viewerYaw = Cesium.Math.toDegrees(marzipanoView.yaw());
  const yaw = Cesium.Math.toRadians((rawYaw + viewerYaw + 75)%360);
  const len = 10.0, halfFov = Cesium.Math.toRadians(22.5);
  function dest(lon,lat,az,dist) {
    const R=6378137, brng=az, d=dist/R;
    const lat1=Cesium.Math.toRadians(lat), lon1=Cesium.Math.toRadians(lon);
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(brng));
    const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat1),Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
    return [Cesium.Math.toDegrees(lon2), Cesium.Math.toDegrees(lat2)];
  }
  for(let off=-0.5; off<=0.5; off+=0.5) {
    const [lonA,latA] = dest(lon,lat,yaw-halfFov+off*0.05,len);
    const [lonB,latB] = dest(lon,lat,yaw+halfFov-off*0.05,len);
    coneEntities.push(viewer.entities.add({
      polygon: {
        hierarchy: Cesium.Cartesian3.fromDegreesArrayHeights([
          lon,lat,height, lonA,latA,height, lonB,latB,height
        ]),
        material: Cesium.Color.LIME.withAlpha(0.4), outline:true, outlineColor: Cesium.Color.LIME
      }
    }));
  }
}

// Main
async function main() {
  const viewer = new Cesium.Viewer('cesiumContainer', {
    baseLayerPicker:false, timeline:false, animation:false, infoBox:false,
    selectionIndicator:false, shouldAnimate:false, sceneMode: Cesium.SceneMode.SCENE2D,
    terrainProvider: new Cesium.EllipsoidTerrainProvider()
  });
  window.cesiumViewer = viewer;
  viewer.scene.morphTo2D(0);
  await loadOverlays(viewer);       // overlays FIRST
  await loadCameraPoints(viewer);   // camera points ON TOP
  // Click handler
  const clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  clickHandler.setInputAction(async function(click) {
    closeImagePopup();
    const picked = viewer.scene.pick(click.position);
    if (picked && picked.id && picked.id.popupImageURL) {
      document.getElementById('imagePopup').style.display='flex';
      document.getElementById('popupLabel').innerText = picked.id.popupLabel||"";
      document.getElementById('pano').innerHTML = "";
      window.panoViewer = new Marzipano.Viewer(document.getElementById('pano'), {stageType:'webgl'});
      const src = Marzipano.ImageUrlSource.fromString(picked.id.popupImageURL);
      const geom = new Marzipano.EquirectGeometry([{ width: 4000 }]);
      const limiter = Marzipano.RectilinearView.limit.traditional(1024, 100*Math.PI/180);
      const view = new Marzipano.RectilinearView(null, limiter);
      const scene = window.panoViewer.createScene({ source:src, geometry:geom, view, pinFirstLevel:true });
      scene.switchTo();
      drawViewCone(viewer, picked, view);
      view.addEventListener('change',()=>drawViewCone(viewer, picked, view));
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}
main();
window.closeImagePopup = closeImagePopup;
</script>
</body>
</html>
